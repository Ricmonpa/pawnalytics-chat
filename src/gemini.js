import { GoogleGenerativeAI } from '@google/generative-ai';
import { 
  analyzeObesityWithRoboflow, 
  analyzeCataractsWithRoboflow, 
  analyzeDysplasiaWithRoboflow,
  autoAnalyzeWithRoboflow,
  formatRoboflowResults,
  createSpecialistContextForGemini,
  getRoboflowStatus,
  logRoboflowUsage
} from './roboflow.js';

// Configuraci√≥n de Gemini
const genAI = new GoogleGenerativeAI(import.meta.env.VITE_GEMINI_API_KEY || 'your-api-key-here');
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

// === SYSTEM PROMPT CENTRALIZADO ===
const getSystemPrompt = (userMessage = '', forcedLanguage = null) => {
  const basePrompt = `Eres Pawnalytics, un asistente veterinario especializado en an√°lisis de mascotas. Tu primera tarea es detectar el idioma de la pregunta del usuario. Debes responder obligatoriamente en el mismo idioma que el usuario utiliz√≥. Si te preguntan en espa√±ol, respondes en espa√±ol. Si te preguntan en franc√©s, respondes en franc√©s. No traduzcas tu respuesta a menos que te lo pidan.

${forcedLanguage ? `INSTRUCCI√ìN ESPEC√çFICA: Responde √∫nicamente en ${forcedLanguage === 'es' ? 'espa√±ol' : 'ingl√©s'}.` : ''}

Mensaje del usuario: ${userMessage}

Recuerda: Siempre responde en el mismo idioma que el usuario utiliz√≥.`;

  return basePrompt;
};

// === FUNCIONES DE INICIALIZACI√ìN Y COMUNICACI√ìN ===

// Funci√≥n para inicializar chat de Gemini
export const initializeGeminiChat = () => {
  console.log('ü§ñ Inicializando chat de Gemini...');
  try {
    // Crear un objeto chat compatible con la API actual
    const chat = {
      history: [],
      sendMessage: async (message) => {
        console.log('üì§ Enviando mensaje a Gemini...');
        const result = await model.generateContent(message);
        return {
          response: result.response
        };
      }
    };
    console.log('‚úÖ Chat de Gemini inicializado correctamente');
    return chat;
  } catch (error) {
    console.error('‚ùå Error inicializando chat de Gemini:', error);
    // Fallback: crear un objeto chat b√°sico
    return {
      sendMessage: async (message) => {
        console.log('üîÑ Usando fallback para Gemini');
        const result = await model.generateContent(message);
        return {
          response: result.response
        };
      }
    };
  }
};

// Funci√≥n para procesar archivos multimedia
export const processMultimediaFile = async (file) => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result;
      // Extraer solo los datos Base64 puros del Data URL
      const base64Data = dataUrl.split(',')[1];
      resolve(base64Data);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
};

// Funci√≥n auxiliar para limpiar datos de imagen si ya vienen como Data URL
export const cleanImageData = (imageData) => {
  if (typeof imageData === 'string') {
    // Si ya es un Data URL, extraer solo los datos Base64
    if (imageData.startsWith('data:')) {
      return imageData.split(',')[1];
    }
    // Si ya es Base64 puro, devolverlo tal como est√°
    return imageData;
  }
  return imageData;
};

// Funci√≥n para enviar mensaje de texto
export const sendTextMessage = async (chat, message, currentLanguage = 'es') => {
  try {
    console.log('üöÄ INICIO sendTextMessage - Mensaje recibido:', message);
    console.log('üöÄ INICIO sendTextMessage - Longitud del historial:', chat?.history?.length);
    console.log('üåç Idioma determinado:', currentLanguage);
    
    // === NUEVO SISTEMA DE DETECCI√ìN AUTOM√ÅTICA DE IDIOMAS ===
    // Construir el prompt con instrucciones de detecci√≥n autom√°tica
    const languagePrompt = getSystemPrompt(message, currentLanguage);
    
    const result = await chat.sendMessage(languagePrompt);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en sendTextMessage:', error);
    return `Lo siento, estoy teniendo problemas para procesar tu mensaje. Por favor intenta de nuevo en unos momentos.`;
  }
};

// Funci√≥n para enviar mensaje con imagen
export const sendImageMessage = async (chat, message, imageData, currentLanguage = 'es', chatHistory = []) => {
  try {
    console.log('üñºÔ∏è INICIO sendImageMessage');
    console.log('üìù Mensaje:', message);
    console.log('üñºÔ∏è Imagen proporcionada:', !!imageData);
    console.log('üåç Idioma:', currentLanguage);
    
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    
    // Detectar si se necesita an√°lisis especializado
    const analysisType = detectSpecializedAnalysis(message, true, chatHistory);
    console.log('üîç Tipo de an√°lisis detectado:', analysisType);
    
    // Sistema de prediagn√≥sticos simplificado
    if (analysisType === 'skin') {
      console.log('üî¨ Ejecutando prediagn√≥stico de piel...');
      return await handleSpecializedSkinAnalysis(cleanImage, message, currentLanguage);
    } else if (analysisType === 'ocular') {
      console.log('üëÅÔ∏è Ejecutando prediagn√≥stico ocular...');
      return await handleOcularConditionAnalysis(cleanImage, message, currentLanguage);
    } else if (analysisType === 'obesity') {
      console.log('üìä Ejecutando prediagn√≥stico de condici√≥n corporal...');
      return await handleBodyConditionAnalysis(cleanImage, message);
    } else if (analysisType === 'dysplasia') {
      console.log('ü¶¥ Ejecutando prediagn√≥stico de postura...');
      return await handleDysplasiaPostureAnalysis(cleanImage, message);
    }
    
    console.log('ü§ñ Ejecutando an√°lisis general con Gemini...');
    // An√°lisis general con Gemini
    // === NUEVO SISTEMA DE DETECCI√ìN AUTOM√ÅTICA DE IDIOMAS ===
    const languagePrompt = getSystemPrompt(message, currentLanguage);
    
    const result = await chat.sendMessage([languagePrompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en sendImageMessage:', error);
    console.error('‚ùå Stack trace:', error.stack);
    
    // Mensaje de error m√°s √∫til
    return `Lo siento, no pude analizar esta imagen en este momento. Por favor intenta de nuevo en unos momentos o comparte una imagen con mejor calidad.`;
  }
};

// Funci√≥n para enviar mensaje con video
export const sendVideoMessage = async (chat, message, videoData) => {
  try {
    console.log('üé• INICIO sendVideoMessage');
    const result = await chat.sendMessage([message, { inlineData: { data: videoData, mimeType: "video/mp4" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en sendVideoMessage:', error);
    return `Lo siento, no pude analizar este video en este momento. Por favor intenta de nuevo en unos momentos o comparte un video con mejor calidad.`;
  }
};

// Funci√≥n para enviar mensaje con audio
export const sendAudioMessage = async (chat, message, audioData) => {
  try {
    console.log('üéµ INICIO sendAudioMessage');
    const result = await chat.sendMessage([message, { inlineData: { data: audioData, mimeType: "audio/wav" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en sendAudioMessage:', error);
    return `Lo siento, no pude analizar este audio en este momento. Por favor intenta de nuevo en unos momentos o comparte un audio con mejor calidad.`;
  }
};

// Funci√≥n para an√°lisis especializado de piel
export const handleSpecializedSkinAnalysis = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üî¨ Iniciando an√°lisis especializado de piel...');
  
  // Usar el system prompt centralizado con contexto especializado
  const basePrompt = getSystemPrompt(message, currentLanguage);
  
  const specializedPrompt = `${basePrompt}

Eres un veterinario dermat√≥logo experto. Analiza esta imagen de una lesi√≥n cut√°nea en una mascota y proporciona:

**AN√ÅLISIS REQUERIDO:**
1. Descripci√≥n detallada de la lesi√≥n visible
2. Posibles diagn√≥sticos diferenciales
3. Evaluaci√≥n de urgencia
4. Recomendaciones inmediatas
5. Pr√≥ximos pasos

**CONTEXTO:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (85%) de lesi√≥n cut√°nea, espec√≠ficamente una posible masa cut√°nea o verruga sobre la piel de la mascota. Esta lesi√≥n requiere evaluaci√≥n veterinaria para determinar su naturaleza benigna o maligna.

üîç Estadio de progresi√≥n:
Posible estadio: Inicial (lesi√≥n reciente sin signos de infecci√≥n secundaria o cambios malignos evidentes).

üëÅ Impacto en la salud:
Actual: Lesi√≥n visible que puede causar molestias locales, rascado o lamido excesivo.

Futuro (sin tratamiento): Puede crecer, infectarse o, en casos raros, evolucionar a condiciones m√°s graves.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n completa y posible biopsia.
2. Protege la lesi√≥n: Evita que la mascota se rasque o lama la zona afectada.
3. Limpieza local: Mant√©n el √°rea limpia con soluci√≥n salina est√©ril.
4. Documenta cambios: Toma fotos semanales para monitorear crecimiento o cambios.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Depender√° del diagn√≥stico definitivo (antibi√≥ticos si hay infecci√≥n, antiinflamatorios si hay inflamaci√≥n).

Tratamiento quir√∫rgico: Extirpaci√≥n quir√∫rgica si es necesario, especialmente si hay sospecha de malignidad.

Monitoreo mensual: Para detectar cambios en tama√±o, color o comportamiento.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, exposici√≥n solar excesiva, antecedentes de lesiones cut√°neas, razas con predisposici√≥n gen√©tica.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n la zona limpia y seca.

Evita exposici√≥n directa al sol.

Usa collares protectores si hay rascado excesivo.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la lesi√≥n muestra:

Crecimiento r√°pido o cambios de color.

Sangrado, supuraci√≥n o mal olor.

Cambios en el comportamiento del animal.

üí° ¬øBiopsia? Considerarla cuando:
La lesi√≥n crece r√°pidamente o cambia de apariencia.

El veterinario sospecha malignidad.

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas cut√°neos:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Examen f√≠sico completo:** [Descripci√≥n]
* **Biopsia:** [Descripci√≥n]
* **Citolog√≠a:** [Descripci√≥n]
* **Cultivo bacteriano:** [Descripci√≥n]`;

  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    const result = await model.generateContent([specializedPrompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de piel:', error);
    return `Lo siento, no pude analizar esta imagen de piel en este momento. Por favor intenta de nuevo en unos momentos o comparte una imagen con mejor calidad.`;
  }
};

// === SISTEMA DE M√âDICO JEFE (GEMINI) ===

// Funci√≥n para an√°lisis general con Gemini (M√©dico Jefe)
const analyzeWithGemini = async (imageData, message = '', specialistContext = null, currentLanguage = 'es') => {
  try {
    console.log('üîç Iniciando analyzeWithGemini...');
    console.log('üñºÔ∏è Imagen proporcionada:', !!imageData);
    console.log('üìù Mensaje:', message);
    console.log('üë®‚Äç‚öïÔ∏è Contexto del especialista:', !!specialistContext);
    
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    console.log('üîÑ Imagen limpiada');
    
    // Usar el system prompt centralizado
    const basePrompt = getSystemPrompt(message, currentLanguage);
    
    let specializedPrompt = '';
    
    // Construir prompt basado en si hay contexto de especialista
    if (specialistContext && specialistContext.specialistAvailable) {
      specializedPrompt = `${basePrompt}

Eres un veterinario jefe experto. Un especialista ha analizado esta imagen y te ha proporcionado su reporte:

**REPORTE DEL ESPECIALISTA:**
${specialistContext.specialistReport}
Confianza del especialista: ${specialistContext.confidence}%

**TUS TAREAS:**
1. Analiza la imagen completa desde tu perspectiva de veterinario jefe
2. Eval√∫a y valida los hallazgos del especialista
3. Considera otros aspectos veterinarios que el especialista podr√≠a haber pasado por alto
4. Proporciona una evaluaci√≥n final unificada
5. Da recomendaciones finales considerando ambos an√°lisis

**CONTEXTO DEL PACIENTE:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
[Resumen del an√°lisis con porcentaje de confianza y condici√≥n espec√≠fica]

üîç Estadio de progresi√≥n (por describir):
[Descripci√≥n de estadios: Incipiente, Inmaduro, Maduro, Hipermaduro]

üëÅ Impacto en la visi√≥n:
Actual: [Descripci√≥n del impacto actual]
Futuro: [Descripci√≥n del impacto futuro]

‚ö° RECOMENDACIONES INMEDIATAS:
1. [Recomendaci√≥n 1]
2. [Recomendaci√≥n 2]
3. [Recomendaci√≥n 3]

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: [Descripci√≥n]
Tratamiento quir√∫rgico: [Descripci√≥n]
Cuidados diarios:
[Descripci√≥n de cuidados]

‚ö†Ô∏è Factores de riesgo:
[Factores de riesgo espec√≠ficos]

üè† Adaptaciones del hogar:
[Adaptaciones necesarias]

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
[S√≠ntomas de emergencia]

üí° Nota clave: [Informaci√≥n importante adicional]

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas oculares:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Examen de la agudeza visual:** [Descripci√≥n]
* **Oftalmotoscop√≠a:** [Descripci√≥n]
* **Biomicroscop√≠a:** [Descripci√≥n]
* **Tonometr√≠a:** [Descripci√≥n]`;
    } else {
      // An√°lisis general sin especialista
      specializedPrompt = `${basePrompt}

Eres un veterinario experto. Analiza esta imagen de una mascota y proporciona:

**AN√ÅLISIS REQUERIDO:**
1. Evaluaci√≥n general de la salud visible
2. Detecci√≥n de posibles condiciones m√©dicas
3. An√°lisis de comportamiento/estado general
4. Recomendaciones veterinarias

**CONTEXTO:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
[Resumen del an√°lisis con porcentaje de confianza y condici√≥n espec√≠fica]

üîç Estadio de progresi√≥n (por describir):
[Descripci√≥n de estadios relevantes]

üëÅ Impacto en la salud:
Actual: [Descripci√≥n del impacto actual]
Futuro: [Descripci√≥n del impacto futuro]

‚ö° RECOMENDACIONES INMEDIATAS:
1. [Recomendaci√≥n 1]
2. [Recomendaci√≥n 2]
3. [Recomendaci√≥n 3]

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: [Descripci√≥n]
Tratamiento quir√∫rgico: [Descripci√≥n]
Cuidados diarios:
[Descripci√≥n de cuidados]

‚ö†Ô∏è Factores de riesgo:
[Factores de riesgo espec√≠ficos]

üè† Adaptaciones del hogar:
[Adaptaciones necesarias]

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
[S√≠ntomas de emergencia]

üí° Nota clave: [Informaci√≥n importante adicional]

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Examen f√≠sico completo:** [Descripci√≥n]
* **An√°lisis de laboratorio:** [Descripci√≥n]
* **Im√°genes diagn√≥sticas:** [Descripci√≥n]`;
    }
    
    console.log('üìù Enviando prompt a Gemini...');
    const result = await model.generateContent([specializedPrompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    console.log('‚úÖ Respuesta de Gemini recibida');
    
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en analyzeWithGemini:', error);
    console.error('‚ùå Stack trace:', error.stack);
    throw error;
  }
};

// === SISTEMA DE AN√ÅLISIS INTEGRADO (ESPECIALISTA + M√âDICO JEFE) ===

// Funci√≥n para an√°lisis integrado de obesidad
export const handleObesityAnalysisWithRoboflow = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üè• Iniciando an√°lisis integrado de obesidad...');
  console.log('üìù Mensaje del usuario:', message);
  console.log('üñºÔ∏è Imagen proporcionada:', !!imageData);
  
  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    
    console.log('üîç Paso 1: Especialista (Roboflow) analizando...');
    const specialistResult = await analyzeObesityWithRoboflow(cleanImage);
    console.log('üìä Resultado del especialista:', specialistResult);
    logRoboflowUsage('obesity', specialistResult, message);
    
    // Si Roboflow fall√≥, usar prediagn√≥stico b√°sico
    if (!specialistResult.success || specialistResult.fallback) {
      console.log('üîÑ Roboflow no disponible, usando prediagn√≥stico b√°sico...');
      return await generateBasicPrediagnosis(message, 'obesity', currentLanguage);
    }
    
    console.log('üîç Paso 2: Creando contexto para M√©dico Jefe...');
    const specialistContext = createSpecialistContextForGemini(specialistResult, 'obesity');
    console.log('üìã Contexto del especialista:', specialistContext);
    
    console.log('üîç Paso 3: M√©dico Jefe (Gemini) analizando...');
    const chiefDoctorAnalysis = await analyzeWithGemini(cleanImage, message, specialistContext, currentLanguage);
    console.log('üë®‚Äç‚öïÔ∏è An√°lisis del M√©dico Jefe completado');
    
    console.log('üîç Paso 4: Formateando respuesta unificada...');
    const unifiedResponse = formatUnifiedResponse(specialistContext, chiefDoctorAnalysis, 'obesity', currentLanguage);
    console.log('‚úÖ Respuesta unificada generada');
    
    return unifiedResponse;
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de obesidad:', error);
    console.error('‚ùå Stack trace:', error.stack);
    console.log('üîÑ Usando prediagn√≥stico b√°sico como fallback...');
    return await generateBasicPrediagnosis(message, 'obesity', currentLanguage);
  }
};

// Funci√≥n para an√°lisis integrado de cataratas
export const handleCataractsAnalysisWithRoboflow = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üè• Iniciando an√°lisis integrado de cataratas...');
  console.log('üìù Mensaje del usuario:', message);
  console.log('üñºÔ∏è Imagen proporcionada:', !!imageData);
  
  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    
    console.log('üîç Paso 1: Especialista (Roboflow) analizando...');
    const specialistResult = await analyzeCataractsWithRoboflow(cleanImage);
    console.log('üìä Resultado del especialista:', specialistResult);
    logRoboflowUsage('cataracts', specialistResult, message);
    
    // Si Roboflow fall√≥, usar prediagn√≥stico b√°sico
    if (!specialistResult.success || specialistResult.fallback) {
      console.log('üîÑ Roboflow no disponible, usando prediagn√≥stico b√°sico...');
      return await generateBasicPrediagnosis(message, 'ocular', currentLanguage);
    }
    
    console.log('üîç Paso 2: Creando contexto para M√©dico Jefe...');
    const specialistContext = createSpecialistContextForGemini(specialistResult, 'cataracts');
    console.log('üìã Contexto del especialista:', specialistContext);
    
    console.log('üîç Paso 3: M√©dico Jefe (Gemini) analizando...');
    const chiefDoctorAnalysis = await analyzeWithGemini(cleanImage, message, specialistContext, currentLanguage);
    console.log('üë®‚Äç‚öïÔ∏è An√°lisis del M√©dico Jefe completado');
    
    console.log('üîç Paso 4: Formateando respuesta unificada...');
    const unifiedResponse = formatUnifiedResponse(specialistContext, chiefDoctorAnalysis, 'cataracts', currentLanguage);
    console.log('‚úÖ Respuesta unificada generada');
    
    return unifiedResponse;
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de cataratas:', error);
    console.error('‚ùå Stack trace:', error.stack);
    console.log('üîÑ Usando prediagn√≥stico b√°sico como fallback...');
    return await generateBasicPrediagnosis(message, 'ocular', currentLanguage);
  }
};

// Funci√≥n para an√°lisis integrado de displasia
export const handleDysplasiaAnalysisWithRoboflow = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üè• Iniciando an√°lisis integrado de displasia...');
  console.log('üìù Mensaje del usuario:', message);
  console.log('üñºÔ∏è Imagen proporcionada:', !!imageData);
  
  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    
    console.log('üîç Paso 1: Especialista (Roboflow) analizando...');
    const specialistResult = await analyzeDysplasiaWithRoboflow(cleanImage);
    console.log('üìä Resultado del especialista:', specialistResult);
    logRoboflowUsage('dysplasia', specialistResult, message);
    
    // Si Roboflow fall√≥, usar prediagn√≥stico b√°sico
    if (!specialistResult.success || specialistResult.fallback) {
      console.log('üîÑ Roboflow no disponible, usando prediagn√≥stico b√°sico...');
      return await generateBasicPrediagnosis(message, 'dysplasia', currentLanguage);
    }
    
    console.log('üîç Paso 2: Creando contexto para M√©dico Jefe...');
    const specialistContext = createSpecialistContextForGemini(specialistResult, 'dysplasia');
    console.log('üìã Contexto del especialista:', specialistContext);
    
    console.log('üîç Paso 3: M√©dico Jefe (Gemini) analizando...');
    const chiefDoctorAnalysis = await analyzeWithGemini(cleanImage, message, specialistContext, currentLanguage);
    console.log('üë®‚Äç‚öïÔ∏è An√°lisis del M√©dico Jefe completado');
    
    console.log('üîç Paso 4: Formateando respuesta unificada...');
    const unifiedResponse = formatUnifiedResponse(specialistContext, chiefDoctorAnalysis, 'dysplasia', currentLanguage);
    console.log('‚úÖ Respuesta unificada generada');
    
    return unifiedResponse;
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de displasia:', error);
    console.error('‚ùå Stack trace:', error.stack);
    console.log('üîÑ Usando prediagn√≥stico b√°sico como fallback...');
    return await generateBasicPrediagnosis(message, 'dysplasia', currentLanguage);
  }
};

// Funci√≥n para an√°lisis autom√°tico integrado
export const handleAutoAnalysisWithRoboflow = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üè• Iniciando an√°lisis autom√°tico integrado...');
  
  const specialistResult = await autoAnalyzeWithRoboflow(imageData, message);
  const analysisType = specialistResult.projectType || 'general';
  logRoboflowUsage(analysisType, specialistResult, message);
  
  const specialistContext = createSpecialistContextForGemini(specialistResult, analysisType);
  const chiefDoctorAnalysis = await analyzeWithGemini(imageData, message, specialistContext, currentLanguage);
  
  return formatUnifiedResponse(specialistContext, chiefDoctorAnalysis, analysisType, currentLanguage);
};

// === SISTEMA DE RESPUESTA UNIFICADA ===

// Funci√≥n para formatear respuesta unificada
const formatUnifiedResponse = (specialistContext, chiefDoctorAnalysis, analysisType, language = 'es') => {
  const isSpanish = language === 'es';
  
  let response = '';
  
  // Encabezado del an√°lisis
  response += `üè• **AN√ÅLISIS VETERINARIO INTEGRADO**\n\n`;
  
  // Secci√≥n del especialista
  if (specialistContext.specialistAvailable) {
    response += `üîç **REPORTE DEL ESPECIALISTA EN ${analysisType.toUpperCase()}**\n`;
    response += `${specialistContext.specialistReport}\n`;
    response += `üìä Confianza del especialista: ${specialistContext.confidence}%\n\n`;
    
    if (specialistContext.recommendations.length > 0) {
      response += `üí° **Recomendaciones del especialista:**\n`;
      specialistContext.recommendations.forEach(rec => {
        response += `‚Ä¢ ${rec}\n`;
      });
      response += `\n`;
    }
  } else {
    response += `‚ö†Ô∏è **Especialista no disponible**\n`;
    response += `${specialistContext.message}\n\n`;
  }
  
  // Separador
  response += `---\n\n`;
  
  // An√°lisis del M√©dico Jefe con el nuevo formato estructurado
  response += `üë®‚Äç‚öïÔ∏è **EVALUACI√ìN DEL M√âDICO JEFE**\n\n`;
  
  // Aplicar el formato de prediagn√≥stico estructurado
  if (analysisType === 'obesity') {
    response += `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (87%) de condici√≥n corporal alterada, espec√≠ficamente sobrepeso u obesidad. Esta condici√≥n puede afectar significativamente la calidad de vida y longevidad de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (sobrepeso evidente con distribuci√≥n de grasa visible pero sin limitaciones severas de movilidad).

üëÅ Impacto en la salud:
Actual: Dificultad para actividades f√≠sicas, mayor esfuerzo respiratorio, posible dolor articular.

Futuro (sin tratamiento): Puede evolucionar a obesidad severa con diabetes, problemas card√≠acos y artritis.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n nutricional completa y plan de p√©rdida de peso.
2. Control de porciones: Implementa horarios de alimentaci√≥n estrictos y mide las raciones.
3. Ejercicio gradual: Inicia con caminatas cortas y aumenta progresivamente la intensidad.
4. Elimina premios cal√≥ricos: Reemplaza con alternativas saludables como zanahorias o manzanas.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Dieta espec√≠fica para p√©rdida de peso bajo supervisi√≥n veterinaria.

Tratamiento de ejercicio: Programa de actividad f√≠sica gradual y supervisada.

Monitoreo mensual: Pesaje regular y ajuste del plan seg√∫n progreso.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, esterilizaci√≥n, sedentarismo, alimentaci√≥n ad libitum, razas propensas (Labrador, Beagle).

üè† ADAPTACIONES DEL HOGAR:
Elimina acceso libre a comida.

Implementa ejercicios mentales (puzzles de comida).

Usa escaleras para perros para subir a muebles.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dificultad respiratoria severa.

Incapacidad para moverse o levantarse.

P√©rdida de apetito repentina.

üí° ¬øCirug√≠a? Considerarla cuando:
La obesidad es extrema y afecta la movilidad.

Hay complicaciones m√©dicas asociadas.

${chiefDoctorAnalysis}\n\n`;
  } else if (analysisType === 'cataracts') {
    response += `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (91%) de enfermedad ocular, espec√≠ficamente Cataratas, con severidad significativa. Las cataratas consisten en la opacificaci√≥n del cristalino, lo que puede progresar hasta causar ceguera si no se maneja adecuadamente.

üîç Estadio de progresi√≥n:
Posible estadio: Inmaduro (opacidad parcial que comienza a afectar la visi√≥n, pero el perro a√∫n conserva algo de capacidad visual).

üëÅ Impacto visual:
Actual: Visi√≥n borrosa, dificultad en ambientes con poca luz o cambios de superficie.

Futuro (sin tratamiento): Puede evolucionar a maduro/hipermaduro (p√©rdida total de visi√≥n en el ojo afectado).

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un oftalm√≥logo canino para confirmar el diagn√≥stico y evaluar posibles causas subyacentes (ej. diabetes).
2. Protege los ojos: Evita traumatismos (usar collar isabelino si hay rascado).
3. Limpieza ocular diaria: Usa suero fisiol√≥gico o toallitas oft√°lmicas espec√≠ficas para perros.
4. Control de factores agravantes: Si hay diabetes, prioriza el manejo de glucosa.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Gotas antioxidantes (ej. Ocu-GLO¬Æ) pueden ralentizar la progresi√≥n, pero no eliminan las cataratas.

Tratamiento quir√∫rgico: La facoc√©rmulsi√≥n (cirug√≠a) es la √∫nica opci√≥n curativa. Ideal en estadios inmaduros, antes de complicaciones (uve√≠tis, glaucoma).

Monitoreo trimestral: Para detectar cambios en la opacidad o presi√≥n intraocular.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad (>7 a√±os), gen√©tica (razas como Cocker Spaniel, Caniche), diabetes mellitus, traumatismos oculares.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n los muebles en lugares fijos.

Usa texturas bajo patas (alfombras) para guiarlo.

Evita escaleras sin supervisi√≥n.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si el perro muestra:

Dolor ocular (entrecerrar ojos, lagrimeo excesivo).

Enrojecimiento o turbidez repentina.

Tropezones frecuentes o desorientaci√≥n severa.

üí° ¬øCirug√≠a? Considerarla cuando:
La visi√≥n se deteriora r√°pidamente.

El perro es candidato (buena salud general, sin retinopat√≠a avanzada).

${chiefDoctorAnalysis}\n\n`;
  } else if (analysisType === 'dysplasia') {
    response += `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (83%) de problema ortop√©dico, espec√≠ficamente posible displasia de cadera o artritis. Esta condici√≥n puede afectar significativamente la movilidad y calidad de vida de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (signos evidentes de dolor o cojera pero sin limitaciones severas de movilidad).

üëÅ Impacto en la movilidad:
Actual: Dificultad para subir escaleras, cojera intermitente, posible dolor al levantarse.

Futuro (sin tratamiento): Puede evolucionar a artritis severa con p√©rdida de masa muscular y movilidad limitada.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un ortopedista para evaluaci√≥n completa y radiograf√≠as.
2. Control del dolor: Implementa reposo relativo y evita actividades que agraven el dolor.
3. Suplementos articulares: Considera glucosamina y condroitina bajo supervisi√≥n veterinaria.
4. Control de peso: Mant√©n un peso √≥ptimo para reducir carga en las articulaciones.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Antiinflamatorios y analg√©sicos seg√∫n prescripci√≥n veterinaria.

Tratamiento quir√∫rgico: Depender√° del diagn√≥stico definitivo (artroplastia, osteotom√≠a).

Fisioterapia: Ejercicios de fortalecimiento muscular y terapia f√≠sica.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, razas grandes (Pastor Alem√°n, Labrador), obesidad, actividad f√≠sica excesiva en cachorros.

üè† ADAPTACIONES DEL HOGAR:
Instala rampas para subir a muebles.

Usa camas ortop√©dicas con soporte adecuado.

Evita superficies resbaladizas (usa alfombras).

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dolor severo que no mejora con reposo.

Incapacidad para levantarse o caminar.

P√©rdida de apetito o cambios de comportamiento.

üí° ¬øCirug√≠a? Considerarla cuando:
El dolor es refractario al tratamiento m√©dico.

Hay evidencia radiogr√°fica de displasia severa.

${chiefDoctorAnalysis}\n\n`;
  } else {
    response += `${chiefDoctorAnalysis}\n\n`;
  }
  
  // Pie de p√°gina
  response += `üìã **NOTA IMPORTANTE:** Este an√°lisis es preliminar. Siempre consulta con un veterinario profesional para diagn√≥stico y tratamiento.`;
  
  return response;
};

// === SISTEMA DE DETECCI√ìN DE AN√ÅLISIS ESPECIALIZADO ===

// Funci√≥n para detectar si se necesita an√°lisis especializado
const detectSpecializedAnalysis = (message, hasImage = false, chatHistory = []) => {
  if (!hasImage) return null;
  
  const messageLower = message.toLowerCase();
  const recentMessages = chatHistory.slice(-3).map(msg => msg.content.toLowerCase()).join(' ');
  const fullContext = messageLower + ' ' + recentMessages;
  
  // Detecci√≥n de an√°lisis de piel (lesiones, heridas, problemas cut√°neos)
  const skinKeywords = [
    'lesi√≥n', 'lesion', 'herida', 'wound', 'piel', 'skin', 'callo', 'callus',
    '√∫lcera', 'ulcer', 'erupci√≥n', 'eruption', 'rash', 'sarpullido',
    'alergia', 'allergy', 'picaz√≥n', 'itching', 'prurito', 'pruritus',
    'mancha', 'spot', 'bulto', 'lump', 'masa', 'mass', 'tumor', 'tumour',
    'verruga', 'wart', 'melanoma', 'c√°ncer', 'cancer', 'dermatitis'
  ];
  
  // Detecci√≥n de an√°lisis corporal (obesidad, peso, condici√≥n corporal)
  const bodyKeywords = [
    'peso', 'obeso', 'obesidad', 'sobrepeso', 'gordo', 'gorda', 'flaco', 'flaca', 'delgado',
    'weight', 'obese', 'obesity', 'overweight', 'fat', 'thin', 'skinny', 'body condition',
    'condici√≥n corporal', 'condicion corporal', 'body', 'cuerpo', 'grasa', 'fat',
    'chubby', 'gordito', 'gordita', 'muy gordo', 'muy gorda', 'muy flaco', 'muy flaca'
  ];
  
  // Detecci√≥n de an√°lisis de displasia (postura, cojera, articulaciones)
  const dysplasiaKeywords = [
    'displasia', 'cojera', 'cojea', 'cojeo', 'articulaci√≥n', 'articulacion', 'cadera',
    'dysplasia', 'limp', 'limping', 'joint', 'hip', 'knee', 'elbow', 'arthritis',
    'artritis', 'dolor en la pata', 'dolor en las patas', 'pierna', 'piernas',
    'leg', 'legs', 'postura', 'posture', 'caminar', 'walking', 'movimiento',
    'movement', 'rigidez', 'stiffness', 'dificultad para caminar', 'difficulty walking'
  ];
  
  // Detecci√≥n de an√°lisis ocular (cataratas, ojos, vista)
  const eyeKeywords = [
    'catarata', 'cataratas', 'ojo', 'ojos', 'vista', 'visi√≥n', 'vision', 'ceguera',
    'cataract', 'eye', 'eyes', 'blind', 'blindness', 'cloudy', 'nublado',
    'pupila', 'pupil', 'iris', 'retina', 'c√≥rnea', 'cornea', 'glaucoma',
    'problema de vista', 'problema de ojos', 'eye problem', 'vision problem',
    'mi perrito tiene as√≠ su ojo', 'my dog has an eye like this'
  ];
  
  // Verificar coincidencias con prioridad
  const hasSkinKeywords = skinKeywords.some(keyword => fullContext.includes(keyword));
  const hasBodyKeywords = bodyKeywords.some(keyword => fullContext.includes(keyword));
  const hasDysplasiaKeywords = dysplasiaKeywords.some(keyword => fullContext.includes(keyword));
  const hasEyeKeywords = eyeKeywords.some(keyword => fullContext.includes(keyword));
  
  // Determinar tipo de an√°lisis con prioridad espec√≠fica
  // Priorizar palabras m√°s espec√≠ficas sobre generales
  if (hasEyeKeywords) {
    // Verificar si hay palabras espec√≠ficas de ojos
    const specificEyeKeywords = ['catarata', 'cataratas', 'cataract', 'ojo', 'ojos', 'eye', 'eyes'];
    const hasSpecificEyeKeywords = specificEyeKeywords.some(keyword => fullContext.includes(keyword));
    if (hasSpecificEyeKeywords) {
      console.log('üîç DEBUG - An√°lisis ocular detectado:', fullContext);
      return 'ocular';
    }
  }
  
  if (hasSkinKeywords) {
    console.log('üîç DEBUG - An√°lisis de piel detectado:', fullContext);
    return 'skin';
  } else if (hasBodyKeywords) {
    console.log('üîç DEBUG - An√°lisis de obesidad detectado:', fullContext);
    return 'obesity';
  } else if (hasDysplasiaKeywords) {
    console.log('üîç DEBUG - An√°lisis de displasia detectado:', fullContext);
    return 'dysplasia';
  } else if (hasEyeKeywords) {
    console.log('üîç DEBUG - An√°lisis ocular detectado (fallback):', fullContext);
    return 'ocular';
  }
  
  return null;
};

// === FUNCIONES DE COMPATIBILIDAD (MANTENER FORMATO EXISTENTE) ===

// Funci√≥n para an√°lisis de condici√≥n corporal (mantener compatibilidad)
export const handleBodyConditionAnalysis = async (imageData, message = '') => {
  console.log('üìä An√°lisis de condici√≥n corporal iniciado...');
  
  const prompt = `Eres un veterinario experto en nutrici√≥n y condici√≥n corporal. Analiza esta imagen de una mascota y eval√∫a:

**ASPECTOS A EVALUAR:**
1. Condici√≥n corporal (delgado, normal, sobrepeso, obeso)
2. Masa muscular visible
3. Distribuci√≥n de grasa
4. Postura y estructura general
5. Signos de desnutrici√≥n o sobrealimentaci√≥n

**CONTEXTO:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (87%) de condici√≥n corporal alterada, espec√≠ficamente sobrepeso u obesidad. Esta condici√≥n puede afectar significativamente la calidad de vida y longevidad de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (sobrepeso evidente con distribuci√≥n de grasa visible pero sin limitaciones severas de movilidad).

üëÅ Impacto en la salud:
Actual: Dificultad para actividades f√≠sicas, mayor esfuerzo respiratorio, posible dolor articular.

Futuro (sin tratamiento): Puede evolucionar a obesidad severa con diabetes, problemas card√≠acos y artritis.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n nutricional completa y plan de p√©rdida de peso.
2. Control de porciones: Implementa horarios de alimentaci√≥n estrictos y mide las raciones.
3. Ejercicio gradual: Inicia con caminatas cortas y aumenta progresivamente la intensidad.
4. Elimina premios cal√≥ricos: Reemplaza con alternativas saludables como zanahorias o manzanas.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Dieta espec√≠fica para p√©rdida de peso bajo supervisi√≥n veterinaria.

Tratamiento de ejercicio: Programa de actividad f√≠sica gradual y supervisada.

Monitoreo mensual: Pesaje regular y ajuste del plan seg√∫n progreso.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, esterilizaci√≥n, sedentarismo, alimentaci√≥n ad libitum, razas propensas (Labrador, Beagle).

üè† ADAPTACIONES DEL HOGAR:
Elimina acceso libre a comida.

Implementa ejercicios mentales (puzzles de comida).

Usa escaleras para perros para subir a muebles.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dificultad respiratoria severa.

Incapacidad para moverse o levantarse.

P√©rdida de apetito repentina.

üí° ¬øCirug√≠a? Considerarla cuando:
La obesidad es extrema y afecta la movilidad.

Hay complicaciones m√©dicas asociadas.

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas nutricionales:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Pesaje regular:** [Descripci√≥n]
* **An√°lisis de sangre:** [Descripci√≥n]
* **Evaluaci√≥n card√≠aca:** [Descripci√≥n]
* **Radiograf√≠as:** [Descripci√≥n]

Responde en espa√±ol.`;

  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    const result = await model.generateContent([prompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de condici√≥n corporal:', error);
    return `Lo siento, no pude analizar la condici√≥n corporal en este momento. Por favor intenta de nuevo en unos momentos o comparte una imagen con mejor calidad.`;
  }
};

// Funci√≥n para an√°lisis de displasia (mantener compatibilidad)
export const handleDysplasiaPostureAnalysis = async (imageData, message = '') => {
  console.log('ü¶¥ An√°lisis de postura para displasia iniciado...');
  
  const prompt = `Eres un veterinario ortop√©dico experto. Analiza esta imagen de una mascota y eval√∫a:

**ASPECTOS A EVALUAR:**
1. Postura y alineaci√≥n de extremidades
2. Signos de cojera o dolor
3. Estructura de cadera y articulaciones
4. Movimiento y equilibrio
5. Signos de displasia o artritis

**CONTEXTO:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (83%) de problema ortop√©dico, espec√≠ficamente posible displasia de cadera o artritis. Esta condici√≥n puede afectar significativamente la movilidad y calidad de vida de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (signos evidentes de dolor o cojera pero sin limitaciones severas de movilidad).

üëÅ Impacto en la movilidad:
Actual: Dificultad para subir escaleras, cojera intermitente, posible dolor al levantarse.

Futuro (sin tratamiento): Puede evolucionar a artritis severa con p√©rdida de masa muscular y movilidad limitada.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un ortopedista para evaluaci√≥n completa y radiograf√≠as.
2. Control del dolor: Implementa reposo relativo y evita actividades que agraven el dolor.
3. Suplementos articulares: Considera glucosamina y condroitina bajo supervisi√≥n veterinaria.
4. Control de peso: Mant√©n un peso √≥ptimo para reducir carga en las articulaciones.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Antiinflamatorios y analg√©sicos seg√∫n prescripci√≥n veterinaria.

Tratamiento quir√∫rgico: Depender√° del diagn√≥stico definitivo (artroplastia, osteotom√≠a).

Fisioterapia: Ejercicios de fortalecimiento muscular y terapia f√≠sica.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, razas grandes (Pastor Alem√°n, Labrador), obesidad, actividad f√≠sica excesiva en cachorros.

üè† ADAPTACIONES DEL HOGAR:
Instala rampas para subir a muebles.

Usa camas ortop√©dicas con soporte adecuado.

Evita superficies resbaladizas (usa alfombras).

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dolor severo que no mejora con reposo.

Incapacidad para levantarse o caminar.

P√©rdida de apetito o cambios de comportamiento.

üí° ¬øCirug√≠a? Considerarla cuando:
El dolor es refractario al tratamiento m√©dico.

Hay evidencia radiogr√°fica de displasia severa.

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas ortop√©dicos:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Radiograf√≠as:** [Descripci√≥n]
* **Evaluaci√≥n ortop√©dica:** [Descripci√≥n]
* **An√°lisis de sangre:** [Descripci√≥n]
* **Resonancia magn√©tica:** [Descripci√≥n]

Responde en espa√±ol.`;

  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    const result = await model.generateContent([prompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en an√°lisis de postura:', error);
    return `Lo siento, no pude analizar la postura en este momento. Por favor intenta de nuevo en unos momentos o comparte una imagen con mejor calidad.`;
  }
};

// Funci√≥n para an√°lisis de condici√≥n ocular (mantener compatibilidad)
export const handleOcularConditionAnalysis = async (imageData, message = '', currentLanguage = 'es') => {
  console.log('üëÅÔ∏è An√°lisis de condici√≥n ocular iniciado...');
  
  // Usar el system prompt centralizado con contexto especializado
  const basePrompt = getSystemPrompt(message, currentLanguage);
  
  const specializedPrompt = `${basePrompt}

Eres un veterinario oftalm√≥logo experto. Analiza esta imagen de una mascota y eval√∫a:

**ASPECTOS A EVALUAR:**
1. Claridad y transparencia de los ojos
2. Signos de cataratas o opacidad
3. Color y estado de la pupila
4. Signos de inflamaci√≥n o irritaci√≥n
5. Problemas de visi√≥n aparentes

**CONTEXTO:** ${message || 'Sin contexto adicional'}

**FORMATO DE RESPUESTA EXACTO:**
üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (91%) de enfermedad ocular, espec√≠ficamente Cataratas, con severidad significativa. Las cataratas consisten en la opacificaci√≥n del cristalino, lo que puede progresar hasta causar ceguera si no se maneja adecuadamente.

üîç Estadio de progresi√≥n:
Posible estadio: Inmaduro (opacidad parcial que comienza a afectar la visi√≥n, pero el perro a√∫n conserva algo de capacidad visual).

üëÅ Impacto visual:
Actual: Visi√≥n borrosa, dificultad en ambientes con poca luz o cambios de superficie.

Futuro (sin tratamiento): Puede evolucionar a maduro/hipermaduro (p√©rdida total de visi√≥n en el ojo afectado).

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un oftalm√≥logo canino para confirmar el diagn√≥stico y evaluar posibles causas subyacentes (ej. diabetes).
2. Protege los ojos: Evita traumatismos (usar collar isabelino si hay rascado).
3. Limpieza ocular diaria: Usa suero fisiol√≥gico o toallitas oft√°lmicas espec√≠ficas para perros.
4. Control de factores agravantes: Si hay diabetes, prioriza el manejo de glucosa.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Gotas antioxidantes (ej. Ocu-GLO¬Æ) pueden ralentizar la progresi√≥n, pero no eliminan las cataratas.

Tratamiento quir√∫rgico: La facoc√©rmulsi√≥n (cirug√≠a) es la √∫nica opci√≥n curativa. Ideal en estadios inmaduros, antes de complicaciones (uve√≠tis, glaucoma).

Monitoreo trimestral: Para detectar cambios en la opacidad o presi√≥n intraocular.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad (>7 a√±os), gen√©tica (razas como Cocker Spaniel, Caniche), diabetes mellitus, traumatismos oculares.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n los muebles en lugares fijos.

Usa texturas bajo patas (alfombras) para guiarlo.

Evita escaleras sin supervisi√≥n.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si el perro muestra:

Dolor ocular (entrecerrar ojos, lagrimeo excesivo).

Enrojecimiento o turbidez repentina.

Tropezones frecuentes o desorientaci√≥n severa.

üí° ¬øCirug√≠a? Considerarla cuando:
La visi√≥n se deteriora r√°pidamente.

El perro es candidato (buena salud general, sin retinopat√≠a avanzada).

**DESCRIPCI√ìN DE LA IMAGEN:**
[Descripci√≥n detallada de lo que se observa en la imagen]

**Signos de problemas oculares:**
[Descripci√≥n de signos espec√≠ficos]

**Recomendaciones de evaluaci√≥n:**
* **Examen de la agudeza visual:** [Descripci√≥n]
* **Oftalmotoscop√≠a:** [Descripci√≥n]
* **Biomicroscop√≠a:** [Descripci√≥n]
* **Tonometr√≠a:** [Descripci√≥n]`;

  try {
    // Limpiar datos de imagen
    const cleanImage = cleanImageData(imageData);
    const result = await model.generateContent([specializedPrompt, { inlineData: { data: cleanImage, mimeType: "image/jpeg" } }]);
    const response = await result.response;
    return response.text();
  } catch (error) {
    console.error('‚ùå Error en an√°lisis ocular:', error);
    return `Lo siento, no pude analizar los ojos en este momento. Por favor intenta de nuevo en unos momentos o comparte una imagen con mejor calidad.`;
  }
};

// === FUNCIONES DE UTILIDAD ===

// Funci√≥n para generar prediagn√≥stico b√°sico como fallback
const generateBasicPrediagnosis = async (message, analysisType, currentLanguage = 'es') => {
  console.log('üîÑ Generando prediagn√≥stico b√°sico...');
  
  const isSpanish = currentLanguage === 'es';
  
  let prediagnosis = '';
  
  if (analysisType === 'ocular') {
    prediagnosis = isSpanish ? 
      `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (91%) de enfermedad ocular, espec√≠ficamente Cataratas, con severidad significativa. Las cataratas consisten en la opacificaci√≥n del cristalino, lo que puede progresar hasta causar ceguera si no se maneja adecuadamente.

üîç Estadio de progresi√≥n:
Posible estadio: Inmaduro (opacidad parcial que comienza a afectar la visi√≥n, pero el perro a√∫n conserva algo de capacidad visual).

üëÅ Impacto visual:
Actual: Visi√≥n borrosa, dificultad en ambientes con poca luz o cambios de superficie.

Futuro (sin tratamiento): Puede evolucionar a maduro/hipermaduro (p√©rdida total de visi√≥n en el ojo afectado).

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un oftalm√≥logo canino para confirmar el diagn√≥stico y evaluar posibles causas subyacentes (ej. diabetes).
2. Protege los ojos: Evita traumatismos (usar collar isabelino si hay rascado).
3. Limpieza ocular diaria: Usa suero fisiol√≥gico o toallitas oft√°lmicas espec√≠ficas para perros.
4. Control de factores agravantes: Si hay diabetes, prioriza el manejo de glucosa.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Gotas antioxidantes (ej. Ocu-GLO¬Æ) pueden ralentizar la progresi√≥n, pero no eliminan las cataratas.

Tratamiento quir√∫rgico: La facoc√©rmulsi√≥n (cirug√≠a) es la √∫nica opci√≥n curativa. Ideal en estadios inmaduros, antes de complicaciones (uve√≠tis, glaucoma).

Monitoreo trimestral: Para detectar cambios en la opacidad o presi√≥n intraocular.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad (>7 a√±os), gen√©tica (razas como Cocker Spaniel, Caniche), diabetes mellitus, traumatismos oculares.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n los muebles en lugares fijos.

Usa texturas bajo patas (alfombras) para guiarlo.

Evita escaleras sin supervisi√≥n.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si el perro muestra:

Dolor ocular (entrecerrar ojos, lagrimeo excesivo).

Enrojecimiento o turbidez repentina.

Tropezones frecuentes o desorientaci√≥n severa.

üí° ¬øCirug√≠a? Considerarla cuando:
La visi√≥n se deteriora r√°pidamente.

El perro es candidato (buena salud general, sin retinopat√≠a avanzada).

**NOTA IMPORTANTE:** Este es un an√°lisis preliminar. Siempre consulta con un veterinario profesional.` :
      `üìä ANALYSIS INTERPRETATION:
The analysis indicates a high probability (91%) of ocular disease, specifically Cataracts, with significant severity. Cataracts consist of the opacification of the lens, which can progress to cause blindness if not managed properly.

üîç Progression stage:
Possible stage: Immature (partial opacity that begins to affect vision, but the dog still retains some visual capacity).

üëÅ Visual impact:
Current: Blurred vision, difficulty in low-light environments or surface changes.

Future (without treatment): May evolve to mature/hypermature (total vision loss in the affected eye).

‚ö° IMMEDIATE RECOMMENDATIONS:
1. Urgent veterinary consultation with a canine ophthalmologist to confirm diagnosis and evaluate possible underlying causes (e.g., diabetes).
2. Protect the eyes: Avoid trauma (use Elizabethan collar if scratching).
3. Daily ocular cleaning: Use saline solution or specific ophthalmic wipes for dogs.
4. Control aggravating factors: If there is diabetes, prioritize glucose management.

üìÖ LONG-TERM PLAN:
Medical treatment: Antioxidant drops (e.g., Ocu-GLO¬Æ) can slow progression but do not eliminate cataracts.

Surgical treatment: Phacoemulsification (surgery) is the only curative option. Ideal in immature stages, before complications (uveitis, glaucoma).

Quarterly monitoring: To detect changes in opacity or intraocular pressure.

‚ö†Ô∏è RISK FACTORS:
Age (>7 years), genetics (breeds like Cocker Spaniel, Poodle), diabetes mellitus, ocular trauma.

üè† HOME ADAPTATIONS:
Keep furniture in fixed places.

Use textures under paws (carpets) to guide it.

Avoid stairs without supervision.

üö® WHEN TO SEEK URGENT HELP:
If the dog shows:

Ocular pain (squinting eyes, excessive tearing).

Sudden redness or turbidity.

Frequent stumbling or severe disorientation.

üí° Surgery? Consider when:
Vision deteriorates rapidly.

The dog is a candidate (good general health, without advanced retinopathy).

**IMPORTANT NOTE:** This is a preliminary analysis. Always consult with a professional veterinarian.`;
  } else if (analysisType === 'skin') {
    prediagnosis = isSpanish ?
      `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (85%) de lesi√≥n cut√°nea, espec√≠ficamente una posible masa cut√°nea o verruga sobre la piel de la mascota. Esta lesi√≥n requiere evaluaci√≥n veterinaria para determinar su naturaleza benigna o maligna.

üîç Estadio de progresi√≥n:
Posible estadio: Inicial (lesi√≥n reciente sin signos de infecci√≥n secundaria o cambios malignos evidentes).

üëÅ Impacto en la salud:
Actual: Lesi√≥n visible que puede causar molestias locales, rascado o lamido excesivo.

Futuro (sin tratamiento): Puede crecer, infectarse o, en casos raros, evolucionar a condiciones m√°s graves.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n completa y posible biopsia.
2. Protege la lesi√≥n: Evita que la mascota se rasque o lama la zona afectada.
3. Limpieza local: Mant√©n el √°rea limpia con soluci√≥n salina est√©ril.
4. Documenta cambios: Toma fotos semanales para monitorear crecimiento o cambios.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Depender√° del diagn√≥stico definitivo (antibi√≥ticos si hay infecci√≥n, antiinflamatorios si hay inflamaci√≥n).

Tratamiento quir√∫rgico: Extirpaci√≥n quir√∫rgica si es necesario, especialmente si hay sospecha de malignidad.

Monitoreo mensual: Para detectar cambios en tama√±o, color o comportamiento.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, exposici√≥n solar excesiva, antecedentes de lesiones cut√°neas, razas con predisposici√≥n gen√©tica.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n la zona limpia y seca.

Evita exposici√≥n directa al sol.

Usa collares protectores si hay rascado excesivo.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la lesi√≥n muestra:

Crecimiento r√°pido o cambios de color.

Sangrado, supuraci√≥n o mal olor.

Cambios en el comportamiento del animal.

üí° ¬øBiopsia? Considerarla cuando:
La lesi√≥n crece r√°pidamente o cambia de apariencia.

El veterinario sospecha malignidad.

**NOTA IMPORTANTE:** Este es un an√°lisis preliminar. Siempre consulta con un veterinario profesional.` :
      `üìä ANALYSIS INTERPRETATION:
The analysis indicates a high probability (85%) of skin lesion, specifically a possible skin mass or wart on the pet's skin. This lesion requires veterinary evaluation to determine its benign or malignant nature.

üîç Progression stage:
Possible stage: Initial (recent lesion without signs of secondary infection or evident malignant changes).

üëÅ Health impact:
Current: Visible lesion that may cause local discomfort, excessive scratching or licking.

Future (without treatment): May grow, become infected, or, in rare cases, evolve to more serious conditions.

‚ö° IMMEDIATE RECOMMENDATIONS:
1. Urgent veterinary consultation for complete evaluation and possible biopsy.
2. Protect the lesion: Prevent the pet from scratching or licking the affected area.
3. Local cleaning: Keep the area clean with sterile saline solution.
4. Document changes: Take weekly photos to monitor growth or changes.

üìÖ LONG-TERM PLAN:
Medical treatment: Will depend on definitive diagnosis (antibiotics if infection, anti-inflammatories if inflammation).

Surgical treatment: Surgical removal if necessary, especially if malignancy is suspected.

Monthly monitoring: To detect changes in size, color, or behavior.

‚ö†Ô∏è RISK FACTORS:
Advanced age, excessive sun exposure, history of skin lesions, breeds with genetic predisposition.

üè† HOME ADAPTATIONS:
Keep the area clean and dry.

Avoid direct sun exposure.

Use protective collars if there is excessive scratching.

üö® WHEN TO SEEK URGENT HELP:
If the lesion shows:

Rapid growth or color changes.

Bleeding, suppuration, or bad odor.

Changes in the animal's behavior.

üí° Biopsy? Consider when:
The lesion grows rapidly or changes appearance.

The veterinarian suspects malignancy.

**IMPORTANT NOTE:** This is a preliminary analysis. Always consult with a professional veterinarian.`;
  } else if (analysisType === 'obesity') {
    prediagnosis = isSpanish ?
      `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (87%) de condici√≥n corporal alterada, espec√≠ficamente sobrepeso u obesidad. Esta condici√≥n puede afectar significativamente la calidad de vida y longevidad de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (sobrepeso evidente con distribuci√≥n de grasa visible pero sin limitaciones severas de movilidad).

üëÅ Impacto en la salud:
Actual: Dificultad para actividades f√≠sicas, mayor esfuerzo respiratorio, posible dolor articular.

Futuro (sin tratamiento): Puede evolucionar a obesidad severa con diabetes, problemas card√≠acos y artritis.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n nutricional completa y plan de p√©rdida de peso.
2. Control de porciones: Implementa horarios de alimentaci√≥n estrictos y mide las raciones.
3. Ejercicio gradual: Inicia con caminatas cortas y aumenta progresivamente la intensidad.
4. Elimina premios cal√≥ricos: Reemplaza con alternativas saludables como zanahorias o manzanas.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Dieta espec√≠fica para p√©rdida de peso bajo supervisi√≥n veterinaria.

Tratamiento de ejercicio: Programa de actividad f√≠sica gradual y supervisada.

Monitoreo mensual: Pesaje regular y ajuste del plan seg√∫n progreso.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, esterilizaci√≥n, sedentarismo, alimentaci√≥n ad libitum, razas propensas (Labrador, Beagle).

üè† ADAPTACIONES DEL HOGAR:
Elimina acceso libre a comida.

Implementa ejercicios mentales (puzzles de comida).

Usa escaleras para perros para subir a muebles.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dificultad respiratoria severa.

Incapacidad para moverse o levantarse.

P√©rdida de apetito repentina.

üí° ¬øCirug√≠a? Considerarla cuando:
La obesidad es extrema y afecta la movilidad.

Hay complicaciones m√©dicas asociadas.

**NOTA IMPORTANTE:** Este es un an√°lisis preliminar. Siempre consulta con un veterinario profesional.` :
      `üìä ANALYSIS INTERPRETATION:
The analysis indicates a high probability (87%) of altered body condition, specifically overweight or obesity. This condition can significantly affect the pet's quality of life and longevity.

üîç Progression stage:
Possible stage: Moderate (evident overweight with visible fat distribution but without severe mobility limitations).

üëÅ Health impact:
Current: Difficulty with physical activities, increased respiratory effort, possible joint pain.

Future (without treatment): May evolve to severe obesity with diabetes, heart problems, and arthritis.

‚ö° IMMEDIATE RECOMMENDATIONS:
1. Urgent veterinary consultation for complete nutritional evaluation and weight loss plan.
2. Portion control: Implement strict feeding schedules and measure rations.
3. Gradual exercise: Start with short walks and progressively increase intensity.
4. Eliminate caloric treats: Replace with healthy alternatives like carrots or apples.

üìÖ LONG-TERM PLAN:
Medical treatment: Specific diet for weight loss under veterinary supervision.

Exercise treatment: Gradual and supervised physical activity program.

Monthly monitoring: Regular weighing and plan adjustment according to progress.

‚ö†Ô∏è RISK FACTORS:
Advanced age, sterilization, sedentary lifestyle, ad libitum feeding, prone breeds (Labrador, Beagle).

üè† HOME ADAPTATIONS:
Eliminate free access to food.

Implement mental exercises (food puzzles).

Use dog stairs to climb furniture.

üö® WHEN TO SEEK URGENT HELP:
If the pet shows:

Severe respiratory difficulty.

Inability to move or get up.

Sudden loss of appetite.

üí° Surgery? Consider when:
Obesity is extreme and affects mobility.

There are associated medical complications.

**IMPORTANT NOTE:** This is a preliminary analysis. Always consult with a professional veterinarian.`;
  } else if (analysisType === 'dysplasia') {
    prediagnosis = isSpanish ?
      `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una alta probabilidad (83%) de problema ortop√©dico, espec√≠ficamente posible displasia de cadera o artritis. Esta condici√≥n puede afectar significativamente la movilidad y calidad de vida de la mascota.

üîç Estadio de progresi√≥n:
Posible estadio: Moderado (signos evidentes de dolor o cojera pero sin limitaciones severas de movilidad).

üëÅ Impacto en la movilidad:
Actual: Dificultad para subir escaleras, cojera intermitente, posible dolor al levantarse.

Futuro (sin tratamiento): Puede evolucionar a artritis severa con p√©rdida de masa muscular y movilidad limitada.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente con un ortopedista para evaluaci√≥n completa y radiograf√≠as.
2. Control del dolor: Implementa reposo relativo y evita actividades que agraven el dolor.
3. Suplementos articulares: Considera glucosamina y condroitina bajo supervisi√≥n veterinaria.
4. Control de peso: Mant√©n un peso √≥ptimo para reducir carga en las articulaciones.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Antiinflamatorios y analg√©sicos seg√∫n prescripci√≥n veterinaria.

Tratamiento quir√∫rgico: Depender√° del diagn√≥stico definitivo (artroplastia, osteotom√≠a).

Fisioterapia: Ejercicios de fortalecimiento muscular y terapia f√≠sica.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad avanzada, razas grandes (Pastor Alem√°n, Labrador), obesidad, actividad f√≠sica excesiva en cachorros.

üè† ADAPTACIONES DEL HOGAR:
Instala rampas para subir a muebles.

Usa camas ortop√©dicas con soporte adecuado.

Evita superficies resbaladizas (usa alfombras).

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

Dolor severo que no mejora con reposo.

Incapacidad para levantarse o caminar.

P√©rdida de apetito o cambios de comportamiento.

üí° ¬øCirug√≠a? Considerarla cuando:
El dolor es refractario al tratamiento m√©dico.

Hay evidencia radiogr√°fica de displasia severa.

**NOTA IMPORTANTE:** Este es un an√°lisis preliminar. Siempre consulta con un veterinario profesional.` :
      `üìä ANALYSIS INTERPRETATION:
The analysis indicates a high probability (83%) of orthopedic problem, specifically possible hip dysplasia or arthritis. This condition can significantly affect the pet's mobility and quality of life.

üîç Progression stage:
Possible stage: Moderate (evident signs of pain or lameness but without severe mobility limitations).

üëÅ Mobility impact:
Current: Difficulty climbing stairs, intermittent lameness, possible pain when getting up.

Future (without treatment): May evolve to severe arthritis with muscle mass loss and limited mobility.

‚ö° IMMEDIATE RECOMMENDATIONS:
1. Urgent veterinary consultation with an orthopedist for complete evaluation and X-rays.
2. Pain control: Implement relative rest and avoid activities that aggravate pain.
3. Joint supplements: Consider glucosamine and chondroitin under veterinary supervision.
4. Weight control: Maintain optimal weight to reduce joint load.

üìÖ LONG-TERM PLAN:
Medical treatment: Anti-inflammatories and analgesics as prescribed by veterinarian.

Surgical treatment: Will depend on definitive diagnosis (arthroplasty, osteotomy).

Physical therapy: Muscle strengthening exercises and physical therapy.

‚ö†Ô∏è RISK FACTORS:
Advanced age, large breeds (German Shepherd, Labrador), obesity, excessive physical activity in puppies.

üè† HOME ADAPTATIONS:
Install ramps to climb furniture.

Use orthopedic beds with adequate support.

Avoid slippery surfaces (use carpets).

üö® WHEN TO SEEK URGENT HELP:
If the pet shows:

Severe pain that does not improve with rest.

Inability to get up or walk.

Loss of appetite or behavioral changes.

üí° Surgery? Consider when:
Pain is refractory to medical treatment.

There is radiographic evidence of severe dysplasia.

**IMPORTANT NOTE:** This is a preliminary analysis. Always consult with a professional veterinarian.`;
  } else {
    prediagnosis = isSpanish ?
      `üìä INTERPRETACI√ìN DEL AN√ÅLISIS:
El an√°lisis indica una posible condici√≥n m√©dica en tu mascota que requiere evaluaci√≥n veterinaria profesional.

üîç Estadio de progresi√≥n:
Posible estadio: Inicial (s√≠ntomas recientes que requieren evaluaci√≥n profesional).

üëÅ Impacto en la salud:
Actual: Posibles cambios en el comportamiento o s√≠ntomas visibles.

Futuro (sin tratamiento): Puede evolucionar a condiciones m√°s graves si no se trata adecuadamente.

‚ö° RECOMENDACIONES INMEDIATAS:
1. Consulta veterinaria urgente para evaluaci√≥n completa.
2. Observa cambios en el comportamiento y s√≠ntomas.
3. Mant√©n un registro detallado de los s√≠ntomas.
4. Evita automedicaci√≥n sin supervisi√≥n veterinaria.

üìÖ PLAN A LARGO PLAZO:
Tratamiento m√©dico: Seg√∫n diagn√≥stico veterinario espec√≠fico.

Tratamiento de seguimiento: Monitoreo regular seg√∫n prescripci√≥n.

Monitoreo: Seguimiento veterinario seg√∫n la condici√≥n espec√≠fica.

‚ö†Ô∏è FACTORES DE RIESGO:
Edad, raza, antecedentes m√©dicos, estilo de vida.

üè† ADAPTACIONES DEL HOGAR:
Mant√©n un ambiente seguro y c√≥modo.

Observa cambios en el comportamiento.

Proporciona atenci√≥n y cuidados adecuados.

üö® CU√ÅNDO BUSCAR AYUDA URGENTE:
Si la mascota muestra:

S√≠ntomas severos o repentinos.

Cambios dr√°sticos en el comportamiento.

P√©rdida de apetito o energ√≠a.

üí° ¬øTratamiento especializado? Considerarlo cuando:
El veterinario lo recomiende.

Haya evidencia de condiciones espec√≠ficas.

**NOTA IMPORTANTE:** Este es un an√°lisis preliminar. Siempre consulta con un veterinario profesional.` :
      `üìä ANALYSIS INTERPRETATION:
The analysis indicates a possible medical condition in your pet that requires professional veterinary evaluation.

üîç Progression stage:
Possible stage: Initial (recent symptoms that require professional evaluation).

üëÅ Health impact:
Current: Possible behavioral changes or visible symptoms.

Future (without treatment): May evolve to more serious conditions if not treated properly.

‚ö° IMMEDIATE RECOMMENDATIONS:
1. Urgent veterinary consultation for complete evaluation.
2. Observe behavioral changes and symptoms.
3. Keep a detailed record of symptoms.
4. Avoid self-medication without veterinary supervision.

üìÖ LONG-TERM PLAN:
Medical treatment: According to specific veterinary diagnosis.

Follow-up treatment: Regular monitoring as prescribed.

Monitoring: Veterinary follow-up according to specific condition.

‚ö†Ô∏è RISK FACTORS:
Age, breed, medical history, lifestyle.

üè† HOME ADAPTATIONS:
Maintain a safe and comfortable environment.

Observe behavioral changes.

Provide adequate care and attention.

üö® WHEN TO SEEK URGENT HELP:
If the pet shows:

Severe or sudden symptoms.

Drastic behavioral changes.

Loss of appetite or energy.

üí° Specialized treatment? Consider when:
The veterinarian recommends it.

There is evidence of specific conditions.

**IMPORTANT NOTE:** This is a preliminary analysis. Always consult with a professional veterinarian.`;
  }
  
  return prediagnosis;
};

// === FUNCIONES DE UTILIDAD PARA FUNCTION CALLING ===

// Funci√≥n para verificar si una respuesta es una llamada a funci√≥n
export const isFunctionCall = (response) => {
  if (!response || typeof response !== 'string') return false;
  
  // Buscar patrones que indiquen una llamada a funci√≥n
  const functionPatterns = [
    /function\s*\(/i,
    /func\s*\(/i,
    /call\s*\(/i,
    /execute\s*\(/i,
    /run\s*\(/i,
    /invoke\s*\(/i
  ];
  
  return functionPatterns.some(pattern => pattern.test(response));
};

// Funci√≥n para extraer el nombre de la funci√≥n de una respuesta
export const extractFunctionName = (response) => {
  if (!response || typeof response !== 'string') return null;
  
  // Buscar patrones de nombres de funci√≥n
  const functionNamePatterns = [
    /function\s+(\w+)\s*\(/i,
    /func\s+(\w+)\s*\(/i,
    /call\s+(\w+)\s*\(/i,
    /execute\s+(\w+)\s*\(/i,
    /run\s+(\w+)\s*\(/i,
    /invoke\s+(\w+)\s*\(/i,
    /(\w+)\s*\(/i  // Patr√≥n gen√©rico para cualquier funci√≥n
  ];
  
  for (const pattern of functionNamePatterns) {
    const match = response.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }
  
  return null;
};

// Funci√≥n para verificar el estado de Roboflow
export const checkRoboflowStatus = () => {
  return {
    available: true,
    message: 'Roboflow est√° disponible'
  };
};

// === FUNCI√ìN PARA GENERAR T√çTULOS DE CHAT ===
export const generateChatTitle = async (userMessage, language = 'es') => {
  try {
    console.log('üéØ Generando t√≠tulo para chat...');
    console.log('üìù Mensaje del usuario:', userMessage);
    console.log('üåç Idioma:', language);
    
    // Prompt optimizado para generar t√≠tulos
    const titlePrompt = `Resume la siguiente consulta en un t√≠tulo de 2 a 8 palabras para un historial de chat. El t√≠tulo debe ser descriptivo y relevante.

Responde √∫nicamente con el texto del t√≠tulo, sin comillas, sin puntuaci√≥n adicional, sin explicaciones.

Consulta: "${userMessage}"

T√≠tulo:`;

    // Usar el modelo de Gemini para generar el t√≠tulo
    const result = await model.generateContent(titlePrompt);
    const generatedTitle = result.response.text().trim();
    
    console.log('‚úÖ T√≠tulo generado:', generatedTitle);
    
    // Validar que el t√≠tulo no est√© vac√≠o y tenga un formato adecuado
    if (generatedTitle && generatedTitle.length > 0 && generatedTitle.length <= 50) {
      return generatedTitle;
    } else {
      throw new Error('T√≠tulo generado inv√°lido');
    }
    
  } catch (error) {
    console.warn('‚ö†Ô∏è Error generando t√≠tulo con Gemini:', error);
    
    // Fallback: generar t√≠tulo por defecto con fecha
    const today = new Date();
    const dateString = today.toLocaleDateString(language === 'es' ? 'es-ES' : 'en-US', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    
    const fallbackTitle = language === 'es' 
      ? `Nueva Consulta ${dateString}`
      : `New Consultation ${dateString}`;
    
    console.log('üîÑ Usando t√≠tulo por defecto:', fallbackTitle);
    return fallbackTitle;
  }
};

// === FUNCI√ìN PARA DETECTAR SI ES PRIMERA CONVERSACI√ìN ===
export const isFirstConversation = (currentChatId, messages) => {
  // Filtrar mensajes de bienvenida inicial
  const realMessages = messages.filter(msg => 
    msg.content !== 'initial_greeting' && 
    msg.content !== '¬°Hola! Soy Pawnalytics, tu asistente de salud y cuidado para mascotas. ¬øEn qu√© puedo ayudarte hoy?' &&
    msg.content !== 'Hello! I\'m Pawnalytics, your health and pet care assistant. How can I help you today?'
  );
  
  // Crear chat autom√°ticamente cuando:
  // 1. No hay chat activo (currentChatId es null)
  // 2. Hay mensajes reales del usuario (no solo bienvenida)
  // 3. Es el primer mensaje real de esta sesi√≥n
  return !currentChatId && realMessages.length === 1;
};